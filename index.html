/**
 * VDC - Planeador Financeiro TVDE
 * Foco: Resiliência Financeira e Antecipação de Risco
 */

let grafico;

function calcularPlaneamento() {
    // 1. Obtenção de Dados
    const inputs = {
        dias: parseInt(document.getElementById('dias').value) || 0,
        km: parseFloat(document.getElementById('km').value) || 0,
        consumo: parseFloat(document.getElementById('consumo').value) || 0,
        preco: parseFloat(document.getElementById('precoCombustivel').value) || 0,
        aluguer: parseFloat(document.getElementById('aluguer').value) || 0,
        seguros: parseFloat(document.getElementById('seguros').value) || 0,
        manutencao: parseFloat(document.getElementById('manutencao').value) || 0,
        extras: parseFloat(document.getElementById('extras').value) || 0,
        segSocial: parseFloat(document.getElementById('segSocial').value) || 0,
        irs: parseFloat(document.getElementById('irs').value) || 0,
        vencimento: parseFloat(document.getElementById('vencimento').value) || 0
    };

    // 2. Cálculos Técnicos
    const custoEnergia = (inputs.km / 100) * inputs.consumo * inputs.preco;
    const totalDespesas = inputs.aluguer + inputs.seguros + inputs.manutencao + inputs.extras + inputs.segSocial + inputs.irs + inputs.vencimento + custoEnergia;

    // Margens de Resiliência VDC
    const margemLucro = totalDespesas * 0.10;
    const margemCaixa = totalDespesas * 0.05;
    const totalRecomendado = totalDespesas + margemLucro + margemCaixa;

    // Metas
    const metaDiaria = (totalDespesas / inputs.dias).toFixed(2);
    const metaKm = (totalDespesas / inputs.km).toFixed(2);
    const metaDiariaRec = (totalRecomendado / inputs.dias).toFixed(2);

    // 3. Atualização da UI
    const resDiv = document.getElementById('resultado');
    resDiv.style.display = 'block';
    resDiv.innerHTML = `
        <h3 style="color:var(--navy); margin-top:0;">Análise de Viabilidade Financeira</h3>
        <strong>Custo Operacional Total:</strong> ${totalDespesas.toFixed(2)}€/mês<br>
        <strong>Meta Mínima de Faturação:</strong> ${metaDiaria}€/dia<br>
        <strong>Break-even por KM:</strong> ${metaKm}€/km<br>
        <hr style="border:0; border-top:1px solid #ccc;">
        <strong style="color:var(--navy);">Meta Diária Recomendada (VDC):</strong> <span style="font-size:1.2rem;">${metaDiariaRec}€/dia</span><br>
        <small>Inclui 10% de Lucro e 5% de Reserva de Emergência para Manutenção/Riscos.</small>
    `;

    document.getElementById('btnPdf').style.display = 'inline-block';
    renderizarGrafico(inputs, custoEnergia, margemLucro, margemCaixa);
}

function renderizarGrafico(inputs, energia, lucro, caixa) {
    const ctx = document.getElementById('graficoCustos');
    ctx.style.display = 'block';
    
    if (grafico) grafico.destroy();
    
    grafico = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Operacional (Viatura)', 'Impostos/Social', 'Vencimento Desejado', 'Energia', 'Reserva/Lucro'],
            datasets: [{
                data: [
                    inputs.aluguer + inputs.seguros + inputs.manutencao + inputs.extras,
                    inputs.segSocial + inputs.irs,
                    inputs.vencimento,
                    energia,
                    lucro + caixa
                ],
                backgroundColor: ['#000080', '#c5a059', '#34A853', '#EA4335', '#FBBC05']
            }]
        },
        options: {
            plugins: { title: { display: true, text: 'Composição do Volume de Faturação' } }
        }
    });
}

function gerarPdfEvidencia() {
    const resHTML = document.getElementById('resultado').innerHTML;
    const canvas = document.getElementById('graficoCustos');
    const imgData = canvas.toDataURL('image/png');
    const dataH = new Date().toLocaleString('pt-PT');

    const htmlRelatorio = `
        <div style="width: 170mm; margin: 0 auto; padding: 15mm; border: 2mm solid #000080; box-sizing: border-box; font-family: Arial, sans-serif; background: #fff;">
            <div style="text-align: center; border-bottom: 2px solid #000080; padding-bottom: 15px; margin-bottom: 20px;">
                <h1 style="color: #000080; margin: 0; font-size: 20px;">PLANEAMENTO FINANCEIRO ESTRATÉGICO</h1>
                <p style="font-weight: bold; margin: 5px 0;">Voz do Condutor — Unidade de Auditoria</p>
            </div>
            <p style="font-size: 12px;"><strong>Data de Emissão:</strong> ${dataH}</p>
            <div style="font-size: 14px; line-height: 1.6; margin-top: 20px;">
                ${resHTML}
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <img src="${imgData}" style="width: 120mm;">
            </div>
            <div style="margin-top: 30px; font-size: 10px; color: #555; background: #f4f4f4; padding: 10px; border-radius: 4px;">
                <strong>AVISO DE RESILIÊNCIA:</strong> Este planeador é uma ferramenta de simulação preditiva. 
                A faturação real pode variar conforme a procura dinâmica e o custo de oportunidade. 
                Mantenha sempre a margem de 5% de caixa ativa.
            </div>
        </div>
    `;

    const opt = {
        margin: 5,
        filename: 'VDC_Planeamento_Financeiro.pdf',
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().from(htmlRelatorio).set(opt).save();
}
